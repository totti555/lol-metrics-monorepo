name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

jobs:
  install-deps:
    name: Install Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "yarn"

      - name: ğŸ“¦ Cache Yarn
        id: cache-deps
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            **/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: ğŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

  lint-build:
    name: Lint & Build
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "yarn"

      - name: ğŸ“¦ Restore Yarn cache
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            **/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: ğŸ§¹ Run linter (back)
        run: yarn workspace lol-metrics-back lint

      - name: ğŸ§¹ Run linter (front)
        run: yarn workspace lol-metrics-view lint

      - name: ğŸ—ï¸ Build backend
        run: yarn workspace lol-metrics-back build

  audit:
    name: Security Audit (Yarn)
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: ğŸ” Audit backend dependencies
        run: yarn workspace lol-metrics-back audit --level high

      - name: ğŸ” Audit frontend dependencies
        run: yarn workspace lol-metrics-view audit --level high

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "yarn"

      - name: ğŸ“¦ Restore Yarn cache
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            **/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: ğŸ§ª Run backend unit tests
        run: yarn workspace lol-metrics-back test
