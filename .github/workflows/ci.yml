name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  COMMUNITY_DRAGON_API_URL: https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default

jobs:
  install-deps:
    name: üõéÔ∏è Install Dependencies ${{ github.event_name == 'push' && '[Merge]' || '[PR]' }}
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "yarn"

      - name: Cache Yarn
        id: cache-deps
        uses: actions/cache@v5
        with:
          path: |
            **/node_modules
            **/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

  lint-build:
    name: üßπ Lint & Build ${{ github.event_name == 'push' && '[Merge]' || '[PR]' }}
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "yarn"

      - name: Restore Yarn cache
        uses: actions/cache@v5
        with:
          path: |
            **/node_modules
            **/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: Run linter (backend)
        run: yarn workspace lol-metrics-back lint

      - name: Run linter (frontend)
        run: yarn workspace lol-metrics-view lint

      - name: Build backend
        run: yarn workspace lol-metrics-back build

  audit:
    name: üîç Security Audit ${{ github.event_name == 'push' && '[Merge]' || '[PR]' }}
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Audit backend dependencies
        run: yarn workspace lol-metrics-back audit --level high

      - name: Audit frontend dependencies
        run: yarn workspace lol-metrics-view audit --level high

  unit-tests:
    name: üß™ Unit Tests ${{ github.event_name == 'push' && '[Merge]' || '[PR]' }}
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "yarn"

      - name: Restore Yarn cache
        uses: actions/cache@v5
        with:
          path: |
            **/node_modules
            **/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: Run backend unit tests
        run: yarn workspace lol-metrics-back test
